apiVersion: batch/v1
kind: Job
metadata:
    # Unique name per release revision ensures re-run on each helm upgrade
    name: {{ include "dcim.fullname" . }}-migration-{{ .Release.Revision }}
    namespace: {{ include "dcim.namespace" . }}
    labels:
        {{- include "dcim.labels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    annotations:
        # Run this job as a helm hook after install/upgrade
        helm.sh/hook: post-install,post-upgrade
        helm.sh/hook-weight: "0"
        helm.sh/hook-delete-policy: before-hook-creation
spec:
    ttlSecondsAfterFinished: 300
    backoffLimit: 3
    template:
        metadata:
            labels:
                {{- include "dcim.labels" . | nindent 16 }}
                app.kubernetes.io/component: migration
        spec:
            restartPolicy: OnFailure
            initContainers:
                - name: wait-for-postgres
                  image: busybox:1.36
                  command:
                      - sh
                      - -c
                      - |
                          until nc -z postgres {{ .Values.postgres.service.port }}; do
                            echo "Waiting for postgres..."
                            sleep 2
                          done
                          echo "Postgres is ready"
            containers:
                - name: migrate
                  image: "{{ if .Values.global.imageRegistry }}{{ .Values.global.imageRegistry }}/{{ end }}{{ .Values.app.image.repository }}:migrate"
                  imagePullPolicy: {{ .Values.app.image.pullPolicy }}
                  command:
                      - sh
                      - -c
                      - |
                          echo "Running database migrations..."
                          npx drizzle-kit migrate
                          echo "Migration complete."
                  envFrom:
                      - secretRef:
                            name: app-secret
