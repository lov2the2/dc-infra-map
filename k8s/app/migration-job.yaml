apiVersion: batch/v1
kind: Job
metadata:
    # Job name includes timestamp â€” regenerate with: scripts/k8s-migrate.sh
    name: dcim-db-migrate
    namespace: dcim
    labels:
        app: dcim-migrate
spec:
    ttlSecondsAfterFinished: 300
    backoffLimit: 3
    template:
        metadata:
            labels:
                app: dcim-migrate
        spec:
            restartPolicy: OnFailure
            initContainers:
                - name: wait-for-postgres
                  image: busybox:1.36
                  command:
                      - sh
                      - -c
                      - |
                          until nc -z postgres 5432; do
                            echo "Waiting for postgres..."
                            sleep 2
                          done
                          echo "Postgres is ready"
            containers:
                - name: migrate
                  image: dc-infra-map:migrate
                  imagePullPolicy: IfNotPresent
                  command:
                      - sh
                      - -c
                      - |
                          echo "Running database migrations..."
                          npx drizzle-kit migrate
                          echo "Migration complete."
                  envFrom:
                      - secretRef:
                            name: app-secret
