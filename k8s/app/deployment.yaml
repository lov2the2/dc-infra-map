apiVersion: apps/v1
kind: Deployment
metadata:
    name: dcim-app
    namespace: dcim
    labels:
        app: dcim-app
spec:
    replicas: 1
    selector:
        matchLabels:
            app: dcim-app
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxUnavailable: 0
            maxSurge: 1
    template:
        metadata:
            labels:
                app: dcim-app
        spec:
            initContainers:
                # Wait for postgres to be ready before starting the app
                - name: wait-for-postgres
                  image: busybox:1.36
                  command:
                      - sh
                      - -c
                      - |
                          until nc -z postgres 5432; do
                            echo "Waiting for postgres..."
                            sleep 2
                          done
                          echo "Postgres is ready"
            containers:
                - name: dcim-app
                  image: dc-infra-map:latest
                  # Use local image (docker-desktop shares Docker daemon)
                  imagePullPolicy: IfNotPresent
                  ports:
                      - containerPort: 3000
                        name: http
                  envFrom:
                      - configMapRef:
                            name: app-config
                      - secretRef:
                            name: app-secret
                  readinessProbe:
                      httpGet:
                          path: /
                          port: 3000
                      initialDelaySeconds: 15
                      periodSeconds: 10
                      failureThreshold: 3
                  livenessProbe:
                      httpGet:
                          path: /
                          port: 3000
                      initialDelaySeconds: 30
                      periodSeconds: 20
                  resources:
                      requests:
                          cpu: 250m
                          memory: 512Mi
                      limits:
                          cpu: 1000m
                          memory: 1Gi
